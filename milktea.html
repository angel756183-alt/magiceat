<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£²æ–™æœ€æ–°æƒ…å ±</title>
    <!-- å¼•å…¥ Tailwind CSS é€²è¡Œå¿«é€Ÿæ’ç‰ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ FontAwesome åœ–æ¨™ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- å¼•å…¥ Markdown è§£æå™¨ (ç”¨æ–¼é¡¯ç¤º AI å›æ‡‰) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fcfcfc; /* Very light, clean background */
        }
        .drink-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .drink-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.15);
        }
        .tag {
            font-size: 0.75rem;
            padding: 0.1rem 0.5rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        /* Loading Animation */
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #ec4899; /* Pink accent */
            border-radius: 50%;
            animation: typing 1s infinite ease-in-out;
            margin: 0 2px;
        }
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="text-gray-800" onload="initializePlaceholderData()">

    <div class="max-w-6xl mx-auto p-6">
        
        <!-- Header: æ¨™é¡Œèˆ‡å‹•æ…‹æ›´æ–°æ—¥æœŸ -->
        <header class="mb-8 text-center bg-white p-6 rounded-2xl shadow-xl border border-gray-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-pink-400 to-orange-500"></div>
            <h1 class="text-4xl font-extrabold text-pink-600 mb-2">
                <i class="fa-solid fa-mug-hot mr-3"></i>é£²æ–™æœ€æ–°æƒ…å ±ç«™
            </h1>
            <!-- å‹•æ…‹æ›´æ–°æ—¥æœŸ -->
            <p class="text-gray-600 text-lg font-bold mb-3" id="updateDateContainer">
                <span id="updateDate">ğŸ“… ç­‰å¾…é¦–æ¬¡æ›´æ–°...</span> 
            </p>
            
            <!-- æ–°å¢æ‰‹å‹•æ›´æ–°æŒ‰éˆ• -->
            <button onclick="fetchAndUpdateNews()" id="updateNewsButton" class="bg-pink-500 text-white font-bold py-2 px-8 rounded-full hover:bg-pink-600 transition shadow-lg flex items-center justify-center mx-auto gap-2 text-base transform hover:scale-105">
                <i class="fa-solid fa-rotate"></i> æ›´æ–°æƒ…å ± (å³æ™‚ç¶²è·¯æœå°‹)
            </button>
            <p id="newsLoading" class="hidden text-sm mt-2 text-pink-600 font-medium">AI æ­£åœ¨æœå°‹æœ€æ–°æƒ…å ±ä¸¦é€²è¡Œæ™‚æ•ˆéæ¿¾...</p>

        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- å·¦å´ï¼šæ–°å“å¿«è¨Š (ä½” 2/3) - åˆå§‹éœæ…‹è³‡æ–™ -->
            <div class="lg:col-span-2 space-y-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-700"><i class="fa-solid fa-calendar-check text-orange-500 mr-2"></i>å³æ™‚ç†±é–€æ–°å“ (æ™‚æ•ˆé™åˆ¶ï¼š60å¤©å…§)</h2>
                    <span class="text-sm text-gray-400" id="dataStatus">æ•¸æ“šç‚ºåˆå§‹ç¯„ä¾‹ (è¼‰å…¥æ™‚ç”Ÿæˆ)</span>
                </div>

                <!-- é€™è£¡çš„å…§å®¹å°‡è¢« JS å‹•æ…‹æ›¿æ› -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="newsGrid">
                    
                    <!-- è¼‰å…¥æ™‚æœƒè¢« initializePlaceholderData æ›¿æ›ç‚ºæœ‰æ•ˆæ•¸æ“š -->
                    <div class="md:col-span-2 text-center py-10 text-gray-400">æ­£åœ¨è¼‰å…¥åˆå§‹è³‡è¨Š...</div>
                </div>
            </div>

            <!-- å³å´ï¼šAI å·¥å…·ç®± + æœå°‹ (ä½” 1/3) -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- âœ¨ AI éš¨èº«é£²æ–™é¡§å• (æ´»åŒ–ç‰ˆï¼Œå·²å•Ÿç”¨ Google æœå°‹) -->
                <div class="bg-gradient-to-br from-rose-50 to-pink-100 rounded-2xl p-6 shadow-md border border-pink-200">
                    <h2 class="text-xl font-bold text-pink-800 mb-4 flex items-center">
                        <i class="fa-solid fa-cloud-arrow-up mr-2 text-pink-600"></i>AI éš¨èº«é¡§å• (å³æ™‚é€£ç·š)
                    </h2>
                    
                    <!-- Feature 1: Mood Selector -->
                    <div class="mb-6">
                        <label class="block font-bold text-pink-900 text-sm mb-2">ğŸ¤” ä»Šå¤©å¿ƒæƒ…/æƒ³å–ä»€éº¼ï¼Ÿ</label>
                        <textarea id="moodInput" class="w-full p-3 rounded-lg border border-pink-200 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400 bg-white" rows="2" placeholder="ä¾‹å¦‚ï¼šæˆ‘éœ€è¦æç¥å’–å•¡å› ã€æƒ³å–æœ€è¿‘Dcardæœ€ç´…çš„é‚£ä¸€æ¯ã€æƒ³è¦æš–æš–èƒƒçš„..."></textarea>
                        
                        <button onclick="recommendDrink()" class="mt-3 w-full bg-gradient-to-r from-orange-400 to-pink-500 text-white font-bold py-2 px-4 rounded-lg hover:from-orange-500 hover:to-pink-600 transition shadow-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-sparkles"></i> AI å¹«æˆ‘é¸ä¸€æ¯ (æœå°‹ç¶²è·¯)
                        </button>
                        
                        <div id="recommendationResult" class="mt-4 hidden">
                            <div class="bg-white p-4 rounded-xl text-sm text-gray-700 shadow-sm border border-pink-100">
                                <div id="recContent" class="prose prose-sm prose-pink"></div>
                                <div id="recSources" class="mt-3 pt-2 border-t border-gray-100 text-xs text-gray-500"></div>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-pink-200 my-4"></div>

                    <!-- Feature 2: IG Post Generator -->
                    <div>
                        <label class="block font-bold text-pink-900 text-sm mb-2">ğŸ“¸ ä¸€éµç”Ÿæˆæ¨å‘æ–‡æ¡ˆ</label>
                        <select id="drinkSelect" class="w-full p-2 rounded-lg border border-pink-200 text-sm mb-2 bg-white">
                            <option value="" disabled selected>è«‹å…ˆé»æ“Šã€Œæ›´æ–°æƒ…å ±ã€æŒ‰éˆ•æˆ–ç­‰å¾…åˆå§‹è¼‰å…¥</option>
                        </select>
                        <button onclick="generatePost()" class="w-full bg-white text-pink-600 border border-pink-300 font-bold py-2 px-4 rounded-lg hover:bg-pink-50 transition flex items-center justify-center gap-2">
                            <i class="fa-brands fa-instagram"></i> ç”Ÿæˆ IG è²¼æ–‡ (ä½¿ç”¨ç•¶å‰æƒ…å ±)
                        </button>
                        
                        <div id="postResult" class="mt-4 hidden">
                            <div class="bg-white p-4 rounded-xl text-sm text-gray-700 shadow-sm border border-pink-100 relative group">
                                <div id="postContent" class="whitespace-pre-wrap font-sans"></div>
                                <button onclick="copyPost()" class="absolute top-2 right-2 text-gray-400 hover:text-pink-500 p-1 bg-white rounded shadow-sm opacity-0 group-hover:opacity-100 transition">
                                    <i class="fa-solid fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¿«é€Ÿæœå°‹å€ -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <h2 class="text-lg font-bold text-gray-700 mb-4"><i class="fa-solid fa-magnifying-glass mr-2"></i>æƒ…å ±ä»»æ„é–€</h2>
                    <div class="space-y-3">
                        <a href="https://www.google.com/search?q=å°ç£æ‰‹æ–é£²æœ€æ–°æ–°å“+Dcard" target="_blank" class="block w-full bg-indigo-50 text-indigo-600 font-bold py-2 px-4 rounded-lg text-center hover:bg-indigo-100 transition border border-indigo-100">
                            <i class="fa-brands fa-google mr-2"></i>Dcard çœŸå¯¦è©•åƒ¹
                        </a>
                        <a href="https://www.instagram.com/explore/tags/æ‰‹æ–é£²æ–°å“/" target="_blank" class="block w-full bg-pink-50 text-pink-600 font-bold py-2 px-4 rounded-lg text-center hover:bg-pink-100 transition border border-pink-100">
                            <i class="fa-brands fa-instagram mr-2"></i>IG #æ‰‹æ–é£²æ–°å“
                        </a>
                    </div>
                </div>

            </div>
        </div>

        <footer class="mt-12 text-center text-gray-400 text-sm">
            <p>Â© 2026 æ´»åŒ–æ‰‹æ–é£²æƒ…å ±å„€è¡¨æ¿ | AI Powered</p>
        </footer>
    </div>

    <!-- Scripts -->
    <script>
        // API Configuration - Your Key has been inserted
        const apiKey = "AIzaSyB0R6Ahmkr1zMGa4pVfbJWzsQo_6dTjcC8"; 

        // Loading Indicator HTML
        const loadingHtml = '<div class="flex items-center gap-2 text-pink-500 font-medium"><div class="typing-indicator" style="background-color: #ec4899;"><span></span><span></span><span></span></div> <span>AI æ­£åœ¨é€£ç·šä¸­...</span></div>';

        // å°ˆé–€ç”¨æ–¼ API Key éºå¤±æ™‚çš„éŒ¯èª¤è¨Šæ¯
        const API_KEY_ERROR_MESSAGE = 'âŒ API é‡‘é‘°éŒ¯èª¤æˆ–é€£ç·šè¢«é˜»æ“‹ã€‚';
        
        let currentDrinksContext = `ç›®å‰å°šç„¡æœ€æ–°æƒ…å ±ï¼Œè«‹å…ˆé»æ“Šã€Œæ›´æ–°æƒ…å ±ã€æŒ‰éˆ•ã€‚`;
        let latestNewsDrinks = [];

        // é¡è‰²æ˜ å°„ (èª¿æ•´ç‚ºæš–è‰²ç³»)
        const brandColorMap = {
            'æ¸…çˆ½': { border: 'border-green-500', tagBg: 'bg-green-100', tagText: 'text-green-700' },
            'è‰è“': { border: 'border-pink-500', tagBg: 'bg-pink-100', tagText: 'text-pink-700' },
            'èŠ‹æ³¥': { border: 'border-purple-500', tagBg: 'bg-purple-100', tagText: 'text-purple-700' },
            'é»‘ç³–': { border: 'border-red-700', tagBg: 'bg-red-100', tagText: 'text-red-700' },
            'å¥¶èŒ¶': { border: 'border-indigo-500', tagBg: 'bg-indigo-100', tagText: 'text-indigo-700' },
            'å’–å•¡': { border: 'border-amber-600', tagBg: 'bg-amber-100', tagText: 'text-amber-700' },
            'ç¶“å…¸': { border: 'border-gray-600', tagBg: 'bg-gray-100', tagText: 'text-gray-800' },
            'èŠå£«': { border: 'border-cyan-500', tagBg: 'bg-cyan-100', tagText: 'text-cyan-700' },
            'èŒ¶': { border: 'border-orange-500', tagBg: 'bg-orange-100', tagText: 'text-orange-700' },
            'æ°´æœ': { border: 'border-lime-500', tagBg: 'bg-lime-100', tagText: 'text-lime-700' },
            'æš–å†¬': { border: 'border-red-400', tagBg: 'bg-red-100', tagText: 'text-red-600' },
            'é™å®š': { border: 'border-pink-400', tagBg: 'bg-pink-100', tagText: 'text-pink-600' },
            // Default color
            'å…¶ä»–': { border: 'border-gray-400', tagBg: 'bg-gray-100', tagText: 'text-gray-600' }
        };

        // åˆå§‹éœæ…‹æ•¸æ“š (è¨­ç‚ºæ¥è¿‘ç•¶å‰æ—¥æœŸï¼Œé¿å…é¦–æ¬¡è¼‰å…¥æ™‚è¢«éæ¿¾æ‰)
        function getInitialData() {
            const today = new Date();
            const dateMinusDays = (days) => {
                const d = new Date(today);
                d.setDate(today.getDate() - days);
                return d.toISOString().split('T')[0];
            };

            return [
                { brand: "äº”æ¡è™Ÿ Wutonghao", name: "è‰è“å¥½æ¿ƒå¥¶è“‹", tag: "è‰è“, é™å®š", releaseDate: dateMinusDays(10), description: ["æ–°é®®å¤§æ¹–è‰è“æ‰“æˆå†°æ²™", "åšåšçš„èŠå£«å¥¶è“‹ï¼Œå£æ„Ÿé¹¹ç”œ", "è‰è“å­£å¿…é»"] },
                { brand: "æ¸…å¿ƒç¦å…¨ Ching Shin", name: "æ¡‚åœ“ç´…æ£—èŒ¶", tag: "æš–å†¬, ç¶“å…¸", releaseDate: dateMinusDays(5), description: ["æš–å†¬é¤Šç”Ÿç³»åˆ—å›æ­¸", "ç´…æ£—ã€æ¡‚åœ“æ…¢ç«ç†¬ç…®", "ç„¡å’–å•¡å› ï¼Œç¡å‰ä¹Ÿèƒ½å–"] },
                { brand: "å¯ä¸å¯ç†Ÿæˆç´…èŒ¶", name: "ç†Ÿæˆå†·éœ²æ­è•¾", tag: "å¥¶èŒ¶, ç¶“å…¸", releaseDate: dateMinusDays(25), description: ["ç¶“å…¸ç†Ÿæˆç´…èŒ¶æ­é…é¦™ç”œå†·éœ²(èœ‚èœœ)", "æ¿ƒéƒé®®å¥¶èŒ¶ï¼ŒèèŸ»äººæœ€æ„›"] },
                { brand: "å¤§è‹‘å­ DaYuanzi", name: "ç¿¡ç¿ é®®æ¾è‘¡è„æŸš", tag: "æ°´æœ, æ¸…çˆ½", releaseDate: dateMinusDays(30), description: ["ä½¿ç”¨ç•¶å­£å°ç£è‘¡è„æŸšé®®æ¾", "æ­é…æ¸…çˆ½ç¶ èŒ¶åŸºåº•", "æœç²’å¤šåˆ°å–ä¸å®Œ"] },
            ];
        }


        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šè¨­ç½®å‹•æ…‹æ—¥æœŸèˆ‡æ™‚é–“ (åƒ…åœ¨æ‰‹å‹•æ›´æ–°æˆåŠŸå¾Œå‘¼å«) ---
        function setDynamicDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');

            const formattedDate = `ğŸ“… æœ€æ–°æ›´æ–°æ—¥æœŸï¼š${year}å¹´ ${month}æœˆ ${day}æ—¥ ${hours}:${minutes}`;
            
            const dateElement = document.getElementById('updateDate');
            if (dateElement) {
                dateElement.textContent = formattedDate;
            }
            document.getElementById('dataStatus').textContent = `è³‡æ–™ä¾†æºï¼šå³æ™‚ç¶²è·¯æœå°‹ä¸¦éæ¿¾ (ç•¶å‰å…±æœ‰ ${latestNewsDrinks.length} ç­†)`;
        }
        // --- æ ¸å¿ƒåŠŸèƒ½ END ---


        /**
         * å¼•ç”¨ä¾†æºé¡¯ç¤ºå‡½æ•¸
         */
        function formatSources(sources) {
            if (!sources || sources.length === 0) return 'ç„¡å³æ™‚ç¶²è·¯è³‡è¨Šè¼”åŠ©ã€‚';
            
            let html = 'å³æ™‚ç¶²è·¯è³‡è¨Šå¼•ç”¨ï¼š';
            sources.forEach((source, index) => {
                html += `<a href="${source.uri}" target="_blank" class="text-pink-600 hover:text-pink-800 hover:underline ml-2">(${index + 1}) ${source.title}</a>`;
            });
            return html;
        }

        /**
         * Generic Function to Call Gemini API with Exponential Backoff
         */
        async function callGeminiAPI(userPrompt, systemInstruction, useSearch = false, maxRetries = 3, responseSchema = null) {
            if (!apiKey) {
                console.error("API Key is missing. Returning null.");
                return null; 
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const headers = { 'Content-Type': 'application/json' };
            
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                ...(useSearch && { tools: [{ "google_search": {} }] }),
                ...(responseSchema && { 
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: responseSchema
                    }
                })
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const candidate = data.candidates?.[0];
                        
                        // Handle structured JSON response
                        if (responseSchema) {
                            try {
                                const jsonText = candidate.content.parts[0].text;
                                const parsedJson = JSON.parse(jsonText);
                                return { json: parsedJson };
                            } catch (e) {
                                console.error("Failed to parse JSON response or received non-JSON:", e);
                                throw new Error("Received non-JSON content or invalid JSON.");
                            }
                        }
                        
                        // Handle standard text response
                        const text = candidate?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼ŒAI æš«æ™‚ç„¡æ³•å›æ‡‰ã€‚";
                        
                        let sources = [];
                        const groundingMetadata = candidate?.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title); 
                        }
                        
                        return { text, sources };

                    } else if (response.status === 429 && attempt < maxRetries - 1) {
                        // Handle rate limit (429)
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; 
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    if (attempt < maxRetries - 1) {
                         const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500;
                         await new Promise(resolve => setTimeout(resolve, delay));
                         continue;
                    }
                    break;
                }
            }
            
            return responseSchema ? { json: null } : { text: "ç™¼ç”Ÿé€£ç·šæˆ–æœå‹™éŒ¯èª¤ï¼Œå·²é‡è©¦å¤šæ¬¡ä½†å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", sources: [] };
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ™‚æ•ˆæ€§éæ¿¾ ---
        /**
         * éæ¿¾è¶…é 60 å¤©çš„å•†å“ï¼Œåªä¿ç•™æœ€æ–°æƒ…å ±ã€‚
         * @param {Array<Object>} drinks - åŸå§‹é£²å“åˆ—è¡¨ï¼ŒåŒ…å« releaseDate æ¬„ä½ (YYYY-MM-DD)ã€‚
         * @returns {Array<Object>} ç¶“éæ¿¾çš„é£²å“åˆ—è¡¨ã€‚
         */
        function filterDrinks(drinks) {
            const retentionDays = 60; // ä¿ç•™ 60 å¤© (ç´„å…©å€‹æœˆ)
            const cutoffTime = retentionDays * 24 * 60 * 60 * 1000; // 60 å¤©çš„æ¯«ç§’æ•¸
            const now = Date.now();
            
            const filtered = drinks.filter(drink => {
                const releaseDate = new Date(drink.releaseDate);
                
                if (isNaN(releaseDate)) {
                    console.warn(`é£²å“ ${drink.name} çš„ä¸Šå¸‚æ—¥æœŸæ ¼å¼ç„¡æ•ˆ: ${drink.releaseDate}ã€‚å°‡å…¶éæ¿¾ã€‚`);
                    return false; 
                }
                
                const timeElapsed = now - releaseDate.getTime();
                
                // å¿…é ˆæ˜¯æ­£æ•¸ (å³ releaseDate ä¸æ™šæ–¼ now)ï¼Œä¸”ä¸è¶…é 60 å¤©
                return timeElapsed >= 0 && timeElapsed <= cutoffTime;
            });
            
            return filtered;
        }

        // --- è¼”åŠ©å‡½æ•¸ï¼šæ ¹æ“šæ¨™ç±¤ç²å–é¡è‰² ---
        function getBrandColor(tag) {
            for (const key in brandColorMap) {
                if (tag && tag.includes(key)) {
                    return brandColorMap[key];
                }
            }
            return brandColorMap['å…¶ä»–'];
        }

        // --- è¼”åŠ©å‡½æ•¸ï¼šæ¸²æŸ“æ–°å“åˆ—è¡¨ ---
        function renderDrinks(drinks) {
            const newsGrid = document.getElementById('newsGrid');
            let html = '';
            let newContext = [];

            if (!drinks || drinks.length === 0) {
                newsGrid.innerHTML = '<div class="md:col-span-2 text-center py-10 text-gray-500 font-bold bg-white p-6 rounded-xl shadow-inner border border-gray-100">ğŸ˜­ æ‰¾ä¸åˆ°è¿‘ 60 å¤©å…§ç™¼å¸ƒçš„æœ‰æ•ˆæƒ…å ±ã€‚</div>';
                latestNewsDrinks = [];
                currentDrinksContext = `ç›®å‰å°šç„¡è¿‘ 60 å¤©æƒ…å ±ï¼Œè«‹é»æ“Šã€Œæ›´æ–°æƒ…å ±ã€æŒ‰éˆ•æœå°‹æœ€æ–°è³‡è¨Šã€‚`;
                document.getElementById('dataStatus').textContent = `æ•¸æ“šç‚ºåˆå§‹ç¯„ä¾‹ (0 ç­†)`;
                updateDrinkSelect([]);
                return;
            }

            drinks.forEach(drink => {
                const colors = getBrandColor(drink.tag);
                
                // æ§‹å»ºæè¿°æ¸…å–®
                const displayDate = drink.releaseDate ? `<li class="font-bold text-pink-600"><i class="fa-solid fa-calendar-alt mr-1"></i> ä¸Šå¸‚æ—¥: ${drink.releaseDate}</li>` : '';
                const descList = drink.description.map(desc => `<li>${desc}</li>`).join('');

                html += `
                    <div class="drink-card bg-white p-5 rounded-xl border-l-4 ${colors.border} shadow-sm">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-lg">${drink.brand}</h3>
                            <span class="tag ${colors.tagBg} ${colors.tagText}">${drink.tag}</span>
                        </div>
                        <p class="text-gray-600 mt-2 text-sm font-bold">ä¸»æ‰“ï¼š${drink.name}</p>
                        <ul class="mt-2 text-sm text-gray-500 list-disc list-inside">
                            ${displayDate}
                            ${descList}
                        </ul>
                    </div>
                `;

                // æ›´æ–° AI é¡§å•çš„å…§å»ºè³‡æ–™
                newContext.push(`${drink.brand} (${drink.name}, ä¸Šå¸‚æ—¥:${drink.releaseDate}): ${drink.description.join(', ')}`);
            });

            newsGrid.innerHTML = html;
            currentDrinksContext = newContext.join('\n');
            latestNewsDrinks = drinks; // å„²å­˜æœ€æ–°çš„çµæ§‹åŒ–è³‡æ–™
            updateDrinkSelect(drinks); // æ›´æ–°ä¸‹æ‹‰é¸å–®
            document.getElementById('dataStatus').textContent = `è³‡æ–™ä¾†æºï¼šå³æ™‚ç¶²è·¯æœå°‹ä¸¦éæ¿¾ (ç•¶å‰å…±æœ‰ ${latestNewsDrinks.length} ç­†)`;
        }
        
        // --- è¼”åŠ©å‡½æ•¸ï¼šæ›´æ–°ä¸‹æ‹‰é¸å–® ---
        function updateDrinkSelect(drinks) {
            const select = document.getElementById('drinkSelect');
            select.innerHTML = ''; // æ¸…ç©ºèˆŠé¸é …

            if (!drinks || drinks.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "è«‹å…ˆæ›´æ–°æƒ…å ± (ç›®å‰ç„¡æœ‰æ•ˆè³‡è¨Š)";
                select.appendChild(option);
                return;
            }

            drinks.forEach(drink => {
                const option = document.createElement('option');
                option.value = `${drink.brand} ${drink.name}`;
                option.textContent = `${drink.brand} - ${drink.name} (${drink.releaseDate})`;
                select.appendChild(option);
            });
            // é è¨­é¸å–ç¬¬ä¸€å€‹
            select.selectedIndex = 0;
        }

        // --- åˆå§‹åŒ–ï¼šè¼‰å…¥éœæ…‹è³‡æ–™ (è®“é é¢è¼‰å…¥æ™‚çœ‹èµ·ä¾†æ˜¯æ­£å¸¸çš„) ---
        function initializePlaceholderData() {
            const initialDrinks = getInitialData();
            renderDrinks(initialDrinks);
            
            // é›–ç„¶æ˜¯éœæ…‹è³‡æ–™ï¼Œä½†è®“æ—¥æœŸé¡¯ç¤ºè¼‰å…¥å®Œæˆ
            document.getElementById('updateDate').textContent = 'ğŸ“… åˆå§‹è³‡è¨Šè¼‰å…¥å®Œæˆ (è«‹é»æ“ŠæŒ‰éˆ•æ›´æ–°)';
        }
        
        // --- ä¸»è¦åŠŸèƒ½ï¼šæ‰‹å‹•æ›´æ–°æƒ…å ± (åŒ…å«ç¶²è·¯æœå°‹) ---
        async function fetchAndUpdateNews() {
            const button = document.getElementById('updateNewsButton');
            const loadingText = document.getElementById('newsLoading');
            const newsGrid = document.getElementById('newsGrid');
            
            // 1. UI ç‹€æ…‹ï¼šé–å®šæŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ä¸­
            button.disabled = true;
            loadingText.classList.remove('hidden');
            newsGrid.innerHTML = `<div class="md:col-span-2 text-center py-10 text-gray-500">${loadingHtml}</div>`;


            // 2. è¨­ç½® JSON Schema (åŒ…å« releaseDate)
            const newsSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "brand": { "type": "STRING", "description": "å“ç‰Œåç¨±ï¼Œå¦‚ï¼šäº”æ¡è™Ÿ" },
                        "name": { "type": "STRING", "description": "é£²å“åç¨±ï¼Œå¦‚ï¼šæµ·é¹½èŠå£«è‘¡è„æŸš" },
                        "tag": { "type": "STRING", "description": "æ¨™ç±¤ï¼Œå¦‚ï¼šæ¸…çˆ½è§£æ¸´ã€å­£ç¯€é™å®šã€å¥¶èŒ¶å¿…é»" },
                        "releaseDate": { "type": "STRING", "description": "é£²å“çš„çœŸå¯¦ä¸Šå¸‚æ—¥æœŸï¼Œå¿…é ˆç‚º YYYY-MM-DD æ ¼å¼ã€‚" },
                        "description": { 
                            "type": "ARRAY", 
                            "items": { "type": "STRING" }, 
                            "description": "2-3 å€‹æè¿°é£²å“ç‰¹é»æˆ–å£æ„Ÿçš„æ¸…å–®é»" 
                        }
                    },
                    required: ["brand", "name", "tag", "releaseDate", "description"]
                }
            };

            const systemPrompt = `
                ä½ æ˜¯ä¸€ä½å°ç£æ‰‹æ–é£²æ–™è¶¨å‹¢å°ˆå®¶ã€‚
                è«‹åˆ©ç”¨ Google æœå°‹åŠŸèƒ½ï¼ŒæŸ¥æ‰¾ç•¶å‰ï¼ˆæˆ–æœ€è¿‘ï¼‰å°ç£æ‰‹æ–é£²ç•Œæœ€ç†±é–€æˆ–æœ€å—æœŸå¾…çš„ 6-8 æ¬¾**çœŸå¯¦**æ–°å“æˆ–è©±é¡Œé£²å“ã€‚
                **éå¸¸é‡è¦ï¼šä½ å¿…é ˆæä¾›é£²å“çš„çœŸå¯¦ä¸Šå¸‚æ—¥æœŸ (YYYY-MM-DD)ï¼Œè«‹å‹™å¿…æœå°‹ä¸¦åŒ…å«æ­¤è³‡è¨Šã€‚** å¦‚æœæœå°‹ä¸åˆ°è¶³å¤ çš„çœŸå¯¦æ–°å“ï¼Œè«‹æä¾›ä½ æ‰¾åˆ°çš„æ‰€æœ‰é …ç›®ã€‚
                è«‹ä»¥ JSON æ ¼å¼å›å‚³ï¼Œè«‹å‹™å¿…ç¢ºä¿ JSON çµæ§‹å®Œæ•´ä¸”ç¬¦åˆ Schemaï¼Œä¸è¦åŒ…å«ä»»ä½•å‰è¨€æˆ–è§£é‡‹æ–‡å­—ã€‚
                å°ç£ç†±é–€å“ç‰ŒåŒ…æ‹¬ï¼šæ¸…å¿ƒç¦å…¨ã€äº”æ¡è™Ÿã€å¯ä¸å¯ã€å¤§è‹‘å­ã€è¿·å®¢å¤ã€éº»å¤èŒ¶åŠã€çç…®ä¸¹ã€æ­‡è…³äº­ã€‚
            `;

            const userQuery = "å°ç£æ‰‹æ–é£²æœ€æ–°æ–°å“æˆ–çˆ†ç´…æ¨è–¦ (è«‹å‹™å¿…æä¾›çœŸå¯¦ä¸Šå¸‚æ—¥æœŸ YYYY-MM-DD)";

            const apiResponse = await callGeminiAPI(
                userQuery, 
                systemPrompt, 
                true, // å•Ÿç”¨ Google Search
                3, 
                newsSchema // ä½¿ç”¨çµæ§‹åŒ– JSON
            );
            
            // 3. è™•ç†å›æ‡‰
            if (!apiResponse) {
                newsGrid.innerHTML = `<div class="md:col-span-2 text-center py-10 text-red-500 font-bold">${API_KEY_ERROR_MESSAGE}</div>`;
            } else if (apiResponse.json) {
                // Step 3a: åŸ·è¡Œæ™‚æ•ˆæ€§éæ¿¾
                const allDrinks = apiResponse.json;
                const filteredDrinks = filterDrinks(allDrinks);

                // Step 3b: æ¸²æŸ“çµæœ
                renderDrinks(filteredDrinks);
                
                // Step 3c: æˆåŠŸå¾Œæ‰æ›´æ–°æ—¥æœŸ
                if (filteredDrinks.length > 0) {
                    setDynamicDate(); 
                }

            } else {
                newsGrid.innerHTML = `<div class="md:col-span-2 text-center py-10 text-red-500 font-bold">âŒ ç™¼ç”Ÿé€£ç·šéŒ¯èª¤ï¼Œç„¡æ³•å–å¾—æœ€æ–°æƒ…å ±ã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚</div>`;
            }
            
            // 4. UI ç‹€æ…‹ï¼šæ¢å¾©æŒ‰éˆ•
            button.disabled = false;
            loadingText.classList.add('hidden');
        }

        /**
         * Feature 1: Recommend Drink (Uses Google Search)
         */
        async function recommendDrink() {
            const input = document.getElementById('moodInput').value.trim();
            const resultDiv = document.getElementById('recommendationResult');
            const contentDiv = document.getElementById('recContent');
            const sourcesDiv = document.getElementById('recSources');
            resultDiv.classList.remove('hidden');
            sourcesDiv.innerHTML = ''; 

            if (!input) {
                contentDiv.innerHTML = '<p class="text-red-500 font-bold">è«‹å…ˆè¼¸å…¥æ‚¨çš„å¿ƒæƒ…æˆ–å£å‘³åå¥½å–”ï¼</p>';
                return;
            }
            if (latestNewsDrinks.length === 0) {
                contentDiv.innerHTML = '<p class="text-red-500 font-bold">è«‹å…ˆé»æ“Šã€Œæ›´æ–°æƒ…å ±ã€æŒ‰éˆ•ï¼Œå–å¾—æœ€æ–°çš„é£²å“è³‡è¨Šã€‚</p>';
                return;
            }

            // UI State: Loading
            contentDiv.innerHTML = loadingHtml;

            const systemPrompt = `
            ä½ æ˜¯ä¸€ä½ç†±æƒ…ã€å°ˆæ¥­çš„å°ç£æ‰‹æ–é£²æ–™é¡§å•ã€‚
            ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šç”¨æˆ¶çš„å¿ƒæƒ…æˆ–å£å‘³åå¥½ï¼Œä¸¦çµåˆ**Google æœå°‹çµæœ**ï¼ˆç²å–æœ€æ–°è¶¨å‹¢æˆ–ç†±é–€è©•åƒ¹ï¼‰ï¼Œå¾**ç•¶å‰é¡¯ç¤ºçš„æƒ…å ±æ¸…å–®**ä¸­ï¼Œæ¨è–¦ **1æ¬¾** æœ€åˆé©çš„é£²æ–™ã€‚
            
            **ç•¶å‰æƒ…å ±æ¸…å–® (æ‰€æœ‰é£²å“éƒ½åœ¨ 60 å¤©æ™‚æ•ˆå…§)ï¼š**
            ${currentDrinksContext}
            
            å›æ‡‰é¢¨æ ¼ï¼š
            1. è¦ªåˆ‡ã€åƒæœ‹å‹ä¸€æ¨£çš„å£å» (å¯ä½¿ç”¨å°ç£ç”¨èª)ã€‚
            2. ä½¿ç”¨é©é‡ Emoji âœ¨ã€‚
            3. æ˜ç¢ºæŒ‡å‡ºæ¨è–¦å“ªä¸€æ¯ï¼Œä¸¦è§£é‡‹ç‚ºä»€éº¼é©åˆä»–ã€‚
            4. å…§å®¹æ§åˆ¶åœ¨ 100-120 å­—ä»¥å…§ï¼Œä¸ç”¨å¤ªé•·ã€‚
            `;

            const { text: responseText, sources } = await callGeminiAPI(
                `ç”¨æˆ¶è¼¸å…¥: ${input}ã€‚è«‹æ ¹æ“šæœ€æ–°è³‡è¨Šå’Œç•¶å‰æƒ…å ±æ¸…å–®ï¼Œå¹«æˆ‘æ¨è–¦ä¸€æ¯é£²æ–™ã€‚`, 
                systemPrompt, 
                true // å•Ÿç”¨ Google Search
            );
            
            // Render the response
            if (responseText === null) {
                contentDiv.innerHTML = `<p class="text-red-500 font-bold">${API_KEY_ERROR_MESSAGE}</p>`;
                return;
            } else if (responseText.startsWith("ç™¼ç”Ÿé€£ç·šæˆ–æœå‹™éŒ¯èª¤")) {
                 contentDiv.innerHTML = `<p class="text-red-500 font-bold">âŒ ${responseText}</p>`;
                 return;
            }
            
            // Render Markdown and Sources
            contentDiv.innerHTML = marked.parse(responseText);
            sourcesDiv.innerHTML = formatSources(sources);
        }

        /**
         * Feature 2: Generate IG Post
         */
        async function generatePost() {
            const drink = document.getElementById('drinkSelect').value;
            const resultDiv = document.getElementById('postResult');
            const contentDiv = document.getElementById('postContent');
            resultDiv.classList.remove('hidden');
            
            if (!drink) {
                contentDiv.textContent = "è«‹å…ˆé»æ“Šã€Œæ›´æ–°æƒ…å ±ã€æŒ‰éˆ•ä¸¦é¸æ“‡ä¸€å€‹é£²å“ã€‚";
                return;
            }

            // UI State: Loading
            contentDiv.textContent = ''; 
            contentDiv.innerHTML = loadingHtml;

            const systemPrompt = `
            ä½ æ˜¯ä¸€ä½æ“…é•·ç¶“ç‡Ÿ Instagram çš„ç¾é£Ÿéƒ¨è½å®¢ã€‚
            è«‹ç‚ºé€™æ¬¾é£²æ–™å¯«ä¸€ç¯‡å¸å¼•äººçš„ã€Œæ¨å‘æ–‡æ¡ˆã€ï¼š${drink}
            åƒè€ƒè³‡è¨Šï¼š${currentDrinksContext}

            æ ¼å¼è¦æ±‚ï¼š
            1. ç¬¬ä¸€è¡Œè¦å¸ç› (Hook)ã€‚
            2. ä¸­é–“æè¿°å£æ„Ÿ (æƒ³åƒå…¶å‘³é“ï¼Œä¾‹å¦‚æ¡‚èŠ±å¾ˆé¦™ã€çƒé¾å›ç”˜)ã€‚
            3. æœ€å¾ŒåŠ ä¸Š 3-5 å€‹ç›¸é—œ Hashtag (#)ï¼Œä¾‹å¦‚ #æ‰‹æ–é£² #æ–°å“ä¸Šå¸‚ #å¿…å–ã€‚
            4. é¢¨æ ¼è¦æ´»æ½‘ã€å¹´è¼•ï¼Œå¤šç”¨ Emojiã€‚
            5. å…§å®¹è«‹ç°¡æ½”ï¼Œé©åˆç™¼é™å‹•æˆ–è²¼æ–‡ã€‚
            `;

            // Note: useSearch is false here for faster, contextual response
            const { text: responseText } = await callGeminiAPI(`å¹«æˆ‘å¯«ä¸€ç¯‡é—œæ–¼ ${drink} çš„è²¼æ–‡`, systemPrompt, false);
            
            // æª¢æŸ¥ API å‘¼å«çµæœ
            if (responseText === null) {
                contentDiv.textContent = API_KEY_ERROR_MESSAGE;
                return;
            } else if (responseText.startsWith("ç™¼ç”Ÿé€£ç·šæˆ–æœå‹™éŒ¯èª¤")) {
                 contentDiv.textContent = `âŒ ${responseText}`;
                 return;
            }
            
            // Set response text (using textContent for IG post as it preserves whitespace)
            contentDiv.textContent = responseText; 
        }

        function copyPost() {
            const text = document.getElementById('postContent').textContent;
            // Use execCommand('copy') for compatibility in environments like iframes
            if (document.execCommand('copy')) {
                // Temporary visual feedback instead of alert
                const copyButton = document.querySelector('#postResult button');
                copyButton.innerHTML = '<i class="fa-solid fa-check"></i> å·²è¤‡è£½';
                copyButton.classList.add('text-green-500');
                setTimeout(() => {
                    copyButton.innerHTML = '<i class="fa-solid fa-copy"></i>';
                    copyButton.classList.remove('text-green-500');
                }, 1500);
            } else {
                // Fallback for environments where execCommand is blocked
                console.log("è¤‡è£½åŠŸèƒ½å—é™ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚"); 
            }
        }
    </script>
</body>
</html>

